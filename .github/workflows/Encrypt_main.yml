name: Auto Encrypt Worker File

on:
  schedule:
    - cron: '*/30 * * * *'  # æ¯30åˆ†é’Ÿæ£€æµ‹ä¸€æ¬¡
  workflow_dispatch:

jobs:
  encrypt-worker:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    # 1. è·å–ç›®æ ‡ä»“åº“æœ€æ–°commit ID
    - name: Fetch latest commit ID
      id: get_commit
      run: |
        LATEST_COMMIT=$(curl -s "https://api.github.com/repos/xrw002/edgetunnel/commits?path=_worker.js&per_page=1" | jq -r '.[0].sha')
        echo "latest_commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT

    # 2. æ¯”å¯¹commitç‰ˆæœ¬å˜åŒ–
    - name: Check for changes
      id: check_diff
      run: |
        LAST_COMMIT=$(cat last_commit.txt 2>/dev/null || echo "init")
        if [ "${{ steps.get_commit.outputs.latest_commit }}" != "$LAST_COMMIT" ]; then
          echo "DIFF=true" >> $GITHUB_OUTPUT
        else
          echo "DIFF=false" >> $GITHUB_OUTPUT
        fi

    # 3. å®‰è£…JavaScriptåŠ å¯†ç¯å¢ƒ
    - name: Setup Node.js
      if: steps.check_diff.outputs.DIFF == 'true'
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    # 4. ä¸‹è½½æœ€æ–°æ–‡ä»¶å¹¶åŠ å¯†
    - name: Download & Encrypt
      if: steps.check_diff.outputs.DIFF == 'true'
      env:
        ENCRYPT_KEY: ${{ secrets.ENCRYPT_KEY }}  # éœ€åœ¨ä»“åº“Secretsè®¾ç½®åŠ å¯†å¯†é’¥
      run: |
        # ä¸‹è½½æºæ–‡ä»¶
        curl -s "https://raw.githubusercontent.com/xrw002/edgetunnel/main/_worker.js" -o _temp.js
        
        # ä½¿ç”¨javascript-obfuscatoråŠ å¯†
        npm install -g javascript-obfuscator
        javascript-obfuscator _temp.js \
          --compact true \
          --controlFlowFlattening true \
          --stringArrayEncoding rc4 \
          --stringArrayThreshold 1 \
          --rotateStringArray true \
          --splitStrings true \
          --identifierNamesGenerator hexadecimal \
          --identifiersPrefix 'edge_' \
          --renameGlobals true \
          --transformObjectKeys true \
          --seed ${{ secrets.ENCRYPT_KEY }} \
          -o src/edge-prod.js
        
        # ä¿å­˜æœ€æ–°commitæ ‡è®°
        echo "${{ steps.get_commit.outputs.latest_commit }}" > last_commit.txt

    # 5. è‡ªåŠ¨æäº¤åŠ å¯†æ–‡ä»¶
    - name: Commit Changes
      if: steps.check_diff.outputs.DIFF == 'true'
      run: |
        git config --global user.name "Security Bot"
        git config --global user.email "security@edge.com"
        git add src/edge-prod.js last_commit.txt
        git commit -m "ğŸ”’ Auto-encrypted worker file (Source: ${{ steps.get_commit.outputs.latest_commit }})"
        git push
